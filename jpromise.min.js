(function(t,e){if(typeof define==="function"&&define.amd){define(e)}else if(typeof exports==="object"){module.exports=e()}else{t.p=e()}})(this,function(){function t(t,e){for(var n in e){t[n]=e[n]}}function e(t){return!!(t&&Object.prototype.toString.call(t)==="[object Function]")}function n(t){return!!(t&&Object.prototype.toString.call(t)==="[object Object]")}function i(t){return!!(t&&Object.prototype.toString.call(t)==="[object Array]")}function r(t){if(typeof t!=="undefined"&&t!==null&&t.toString&&t.toString()==="[object Promise]"){return true}return false}function a(t){if(typeof t!=="undefined"&&t!==null&&t.toString&&t.toString()==="[object Deferred]"){return true}return false}var s=root.setTimeout;if(process&&e(process.nextTick)){s=process.nextTick}function o(t,e,n){s(function(){n.forEach(function(n){n.call(t,e)})},0)}function l(t){if(t&&!i(t)){t=[t]}return t}var c={mine:"mine"};var f=c;function h(t,n,i){return function(r){f=c;if(t&&e(t)){try{f=t.call(undefined,r)}catch(a){f=c;n.reject(a)}if(f!==c){if(i==="reject"){n.resolve(f)}else{n[i](f)}}}else{n[i](r)}}}function u(t,e){t.done(function(t){e.doResolve(t)});t.fail(function(t){e.doReject(t)});t.progress(function(t){e.doNotify(t)})}function d(t,e,n){switch(e){case"resolve":n.doResolve(t);break;case"reject":n.doReject(t);break;case"notify":n.doNotify(t);break}}function p(t,e){var n={failed:false,datasThen:undefined};try{n.datasThen=t.then}catch(i){n.datasThen=undefined;n.failed=true;e.doReject(i)}return n}function y(t,e,n){var i=false;try{var r=new b;r.done(function(t){n.doResolve(t)}).fail(function(t){n.doReject(t)}).progress(function(t){n.doProgress(t)});t.call(e,function(t){if(!i){i=true;r.resolve(t)}},function(t){if(!i){i=true;r.reject(t)}},function(t){r.notify(t)})}catch(a){if(!i){n.doReject(a)}}}function v(t,n,i){var r=p(t,i);if(!r.failed){if(e(r.datasThen)){y(r.datasThen,t,i)}else{d(t,n,i)}}}var b=function(t){this.internalState=0;this.internalWith=undefined;this.internalData=null;this.callbacks={done:[],fail:[],always:[],progress:[]};this._pro=null;if(t&&e(t)){t.call(this,this)}return this};var g=function(e,i){this.done=e.done.bind(e);this.fail=e.fail.bind(e);this.progress=e.progress.bind(e);this.always=e.always.bind(e);this.then=e.then.bind(e);this.state=function(){return e.internalState};if(i&&n(i)){t(i,this);return i}return this};t(g.prototype,{toString:function(){return"[object Promise]"}});t(b.prototype,{toString:function(){return"[object Deferred]"},Promise:g,notify:function(t){if(this.internalState===0){this.internalData=t;o(this.internalWith,this.internalData,this.callbacks.progress)}return this},notifyWith:function(t,e){if(this.internalState===0){this.internalWith=t;this.internalData=e;o(this.internalWith,this.internalData,this.callbacks.progress)}return this},doNotify:function(t){this.internalData=t;o(this.internalWith,this.internalData,this.callbacks.progress)},reject:function(t){if(this.internalState===0){this.deNestSanitizeTheInsanityAndCall(t,"reject")}return this},rejectWith:function(t,e){if(this.internalState===0){this.internalWith=t;this.deNestSanitizeTheInsanityAndCall(e,"reject")}return this},doReject:function(t){this.internalData=t;this.internalState=2;o(this.internalWith,this.internalData,this.callbacks.fail.concat(this.callbacks.always))},resolve:function(t){if(this.internalState===0){this.deNestSanitizeTheInsanityAndCall(t,"resolve")}return this},resolveWith:function(t,e){if(this.internalState===0){this.internalWith=t;this.deNestSanitizeTheInsanityAndCall(e,"resolve")}return this},doResolve:function(t){this.internalData=t;this.internalState=1;o(this.internalWith,this.internalData,this.callbacks.done.concat(this.callbacks.always))},always:function(t){t=l(t);if(t.length>0){if(this.internalState!==0){o(this.internalWith,this.internalData,t)}else{this.callbacks.always=this.callbacks.always.concat(t)}}return this.promise()},done:function(t){t=l(t);if(t.length>0){if(this.internalState===1){o(this.internalWith,this.internalData,t)}else{this.callbacks.done=this.callbacks.done.concat(t)}}return this.promise()},fail:function(t){t=l(t);if(t.length>0){if(this.internalState===2){o(this.internalWith,this.internalData,t)}else{this.callbacks.fail=this.callbacks.fail.concat(t)}}return this.promise()},progress:function(t){if(this.internalState===0){t=l(t);this.callbacks.progress=this.callbacks.progress.concat(t)}return this.promise()},deNestSanitizeTheInsanityAndCall:function(t,i){if(t===this.promise()){this.doReject(new TypeError("Promise Tried to Resolve with Self"))}else if(r(t)){u(t,this)}else if(n(t)||e(t)){v(t,i,this)}else{d(t,i,this)}},then:function(t,e,n){var i=new b;this.done(h(t,i,"resolve")).fail(h(e,i,"reject")).progress(h(n,i,"notify"));return i.promise()},wrap:function(t){var i=new b;var s;if(r(t)||a(t)){u(t,i)}else if(n(t)||e(t)){v(t,"resolve",i)}else{i.resolve(t)}return i.promise()},when:function(){var t=Array.prototype.slice.call(arguments);var e=[];var n=new b;var s=0;var o=0;var l=[];t.forEach(function(t){if(i(t)){e=e.concat(t)}else{e.push(t)}});if(e.length===0){n.resolve(l)}e.forEach(function(t,i){if(r(t)||a(t)){t.done(function(t){s++;o++;l[i]=t;n.notify({index:i,action:"resolved",data:t,resolved:s,handled:o});if(s===e.length){n.resolve(l)}else if(o===e.length){n.reject(l)}}).fail(function(t){o++;l[i]=t;n.notify({index:i,action:"rejected",data:t,resolved:s,handled:o});if(s===e.length){n.resolve(l)}else if(o===e.length){n.reject(l)}}).progress(function(t){n.notify(t)})}else if(!!t){s++;o++;l[i]=t}else{o++;l[i]=t}});if(s===e.length){n.resolve(l)}else if(o===e.length){n.reject(l)}return n.promise()},promise:function(t){if(!this._pro){this._pro=new this.Promise(this,t)}return this._pro},state:function(){return this.internalState}});b.when=b.prototype.when;b.wrap=b.prototype.wrap;if(Object.freeze){Object.freeze(b.prototype)}return b});